!function(e){"use strict";var r,a,i,s,o,l,c,d,n,u=[],v=Promise.resolve();function t(e){return e?(d.addEventListener("keypress",f),d.addEventListener("submit",E),d.addEventListener("drop",g),a.addEventListener("click",p),i.addEventListener("click",L),s.addEventListener("click",h),Chat.show().then(function(){Utils.sendEvent("chatView:shown"),C(),o.focus()})):(d.removeEventListener("keypress",f),a.removeEventListener("click",p),i.removeEventListener("click",L),s.removeEventListener("click",h),d.removeEventListener("drop",g),Chat.hide().then(function(){Utils.sendEvent("chatView:hidden")}))}function m(e){n={incomingMessage:{name:"chatController:incomingMessage",handler:function(e){var t=e.detail.data;!function(e){var t=HTMLElems.createElementAt(c,"li"),n=HTMLElems.createElementAt(t,"p");{var r,a;otHelper.isMyself({connectionId:e.senderId})?t.classList.add("yourself"):(-1===(r=u.indexOf(e.senderId))&&(r=u.push(e.senderId)-1),a=r.toString().slice(-1),n.data("participant-number",a))}var i=e.time.toLowerCase();HTMLElems.createElementAt(n,"span",null,i).classList.add("time"),HTMLElems.createElementAt(n,"span",null,e.sender||e.userName).classList.add("sender"),y(n,e.text),C()}(t),v.then(function(){return Chat.visible}).then(function(e){e||Utils.sendEvent("chatView:unreadMessage",{data:t})})}},presenceEvent:{name:"chatController:presenceEvent",handler:function(e){!function(e){var t=(e.time||Utils.getCurrentTime()).toLowerCase(),n=HTMLElems.createElementAt(c,"li");n.classList.add("event");var r=e.sender||e.userName,a=t+" - "+r+" "+e.text;y(n,a),C()}(e.detail)}},messageDelivered:{name:"chatController:messageDelivered",handler:function(){o.value=""}},chatVisibility:{name:"roomView:chatVisibility",handler:function(e){v=t(e.detail)},couldBeChanged:!0}},Array.isArray(e)&&e.forEach(function(e){var t=n[e.type];t&&t.couldBeChanged&&(t.name=e.name)}),Utils.addHandlers(n)}var h=function(e){e.preventDefault(),o.value.trim().length&&(void 0!==window.orientation?document.activeElement.blur():o.focus(),Utils.sendEvent("chatView:outgoingMessage",{sender:r,time:Utils.getCurrentTime(),text:o.value.trim()}))},f=function(e,t){var n;if(window.vent)n=window.event.keyCode;else{if(!t)return!0;n=t.which}return 13!==n||(!0===t.shiftKey||(h(t),!1))}.bind(void 0,o),E=function(e){return e.preventDefault(),!1},p=function(e){e.preventDefault(),e.stopImmediatePropagation(),v=t(!1)},L=function(){Chat.isCollapsed()?Chat.expand():Chat.collapse()},g=function(e){return e.preventDefault(),e.stopPropagation(),!1};function y(e,t){var n=TextProcessor.parse(t),r=HTMLElems.createElementAt(e,"p");n.forEach(function(e){e.type===TextProcessor.TYPE.URL?HTMLElems.createElementAt(r,"a",{href:e.value,target:"_blank"},e.value):HTMLElems.addText(r,e.value)})}function C(){l.scrollTop=l.scrollHeight}var w={init:function(t,n){return LazyLoader.dependencyLoad(["/js/helpers/textProcessor.js","/js/components/chat.js"]).then(function(){var e;e=document.getElementById("chat"),i=e.querySelector("header"),a=e.querySelector("#closeChat"),s=e.querySelector("#sendTxt"),o=e.querySelector("#msgText"),l=e.querySelector("#chatMsgs"),c=l.querySelector("ul"),d=e.querySelector("#chatForm"),r=t,Chat.init(),m(n)})}};e.ChatView=w}(this);