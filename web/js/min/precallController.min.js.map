{"version":3,"sources":["web/js/precallController.js"],"names":["exports","otNetworkTest","publisher","previewOptions","publisherOptions","publishAudio","publishVideo","name","width","height","insertMode","showControls","storedAudioDeviceId","window","localStorage","getItem","storedVideoDeviceId","audioSource","videoSource","eventHandlers","roomView:endprecall","Utils","sendEvent","PrecallController","init","Promise","resolve","LazyLoader","dependencyLoad","then","addEventsHandlers","PrecallView","showCallSettingsPrompt","roomName","username","otHelper","selector","videoPreviewEventHandlers","[object Object]","toggleFacingMode","dev","deviceId","setItem","evt","detail","setAudioSource","status","startPrecallTestMeter","startNetworkTest","error","result","displayNetworkTestResults","hideConnectivityTest","stopTest","routedFromStartMeeting","userName","document","querySelector","value","trim","otLoaded","hidePrecall","hide","destroy","isIE","setTimeout","submitForm","location","href","indexOf","reject","Request","getRoomRawInfo","room","showUnavailable","Error","isLocked","showTos","showContract","catch","e","message","showLockedMessage","showUnavailableMessage","setFocus","isSafariIOS","enablePrecallTest","disabled","addEventListener","event","which","preventDefault","initPublisher","pub","getVideoDeviceNotInUse","videoSourceId","apiKey","precallApiKey","resolution","sessionId","precallSessionId","token","precallToken","on","getDevices","audioDevs","populateAudioDevicesDropdown","OTNetworkTest","audioOnly","movingAvg","audioLevel","logLevel","Math","log","LN10","min","max","setVolumeMeterLevel","userNameInputElement","getElementById","storedUsername","style","display","setAttribute","classList","add","this"],"mappings":"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","sourcesContent":["// eslint-disable-next-line no-unused-vars\n/* global Modal, OTNetworkTest, PrecallView, showTos, showUnavailable */\n\n!(exports => {\n  const endPrecall = () => {\n    Utils.sendEvent('PrecallController:endPrecall');\n  };\n  let otNetworkTest;\n  let publisher;\n  let previewOptions;\n  const publisherOptions = {\n    publishAudio: true,\n    publishVideo: true,\n    name: '',\n    width: '100%',\n    height: '100%',\n    insertMode: 'append',\n    showControls: false\n  };\n\n  const storedAudioDeviceId = window.localStorage.getItem('audioDeviceId');\n  const storedVideoDeviceId = window.localStorage.getItem('videoDeviceId');\n  if (storedAudioDeviceId) publisherOptions.audioSource = storedAudioDeviceId;\n  if (storedVideoDeviceId) publisherOptions.videoSource = storedVideoDeviceId;\n\n  function showCallSettingsPrompt(roomName, username, otHelper) {\n    const selector = '.user-name-modal';\n\n    const videoPreviewEventHandlers = {\n      toggleFacingMode() {\n        otHelper.toggleFacingMode().then(dev => {\n          const deviceId = dev.deviceId;\n          publisherOptions.videoSource = deviceId;\n          window.localStorage.setItem('videoDeviceId', deviceId);\n        });\n      },\n      setAudioSource(evt) {\n        const deviceId = evt.detail;\n        otHelper.setAudioSource(deviceId);\n        publisherOptions.audioSource = deviceId;\n        window.localStorage.setItem('audioDeviceId', deviceId);\n      },\n      initialAudioSwitch(evt) {\n        publisher.publishAudio(evt.detail.status);\n        publisherOptions.publishAudio = evt.detail.status;\n      },\n      initialVideoSwitch(evt) {\n        publisher.publishVideo(evt.detail.status);\n        publisherOptions.publishVideo = evt.detail.status;\n      },\n      retest() {\n        PrecallView.startPrecallTestMeter();\n        otNetworkTest.startNetworkTest((error, result) => {\n          if (!error) {\n            PrecallView.displayNetworkTestResults(result);\n          }\n        });\n      },\n      cancelTest() {\n        PrecallView.hideConnectivityTest();\n        otNetworkTest.stopTest();\n      }\n    };\n\n    return new Promise(resolve => {\n      if (window.routedFromStartMeeting) {\n        publisherOptions.name = window.userName || document.querySelector(`${selector} input`).value.trim();\n        return resolve({\n          username: window.userName || document.querySelector(`${selector} input`).value.trim(),\n          publisherOptions\n        });\n      }\n\n      function loadModalText() {\n        PrecallView.setFocus(username);\n\n        if (Utils.isIE() || Utils.isSafariIOS()) {\n          if (window.enablePrecallTest) PrecallView.hideConnectivityTest();\n        }\n\n        document.querySelector('.user-name-modal #enter').disabled = false;\n        document.querySelector('.user-name-modal').addEventListener('keypress', event => {\n          if (event.which === 13) {\n            event.preventDefault();\n            submitForm();\n          }\n        });\n\n        document.querySelector('.user-name-modal').addEventListener('submit', event => {\n          event.preventDefault();\n          submitForm();\n        });\n\n        function hidePrecall() {\n          PrecallView.hide();\n          publisher && publisher.destroy();\n          if (!Utils.isIE()) {\n            otNetworkTest && otNetworkTest.stopTest();\n          }\n          const username = document.querySelector(`${selector} input`).value.trim();\n          window.localStorage.setItem('username', username);\n          publisherOptions.name = username;\n          setTimeout(() => {\n            resolve({\n              username,\n              publisherOptions\n            });\n          }, 1);\n        }\n\n        function submitRoomForm() {\n          function isAllowedToJoin() {\n            return new Promise((resolve, reject) => {\n              Request\n                .getRoomRawInfo(roomName).then((room) => {\n                  if (window.routedFromStartMeeting) {\n                    return resolve();\n                  } else if (showUnavailable && !room) {\n                    return reject(new Error('New rooms not allowed'));\n                  } else if (room && !room.isLocked) {\n                    return resolve();\n                  } else if (!showUnavailable && !room) {\n                    return resolve();\n                  } else if (room && room.isLocked) {\n                    return reject(new Error('Room locked'));\n                  }\n                  // default\n                  return reject(new Error('Unknown Room State'));\n                });\n            });\n          }\n\n          isAllowedToJoin().then(() => {\n            if (showTos) {\n              PrecallView.showContract().then(hidePrecall);\n            } else {\n              hidePrecall();\n            }\n          }).catch((e) => {\n            if (e.message === 'Room locked') {\n              PrecallView.showLockedMessage();\n            } else {\n              PrecallView.showUnavailableMessage();\n            }\n          });\n        }\n\n        function submitForm() {\n          if (window.location.href.indexOf('room') > -1) {\n            // Jeff to do: This code should move to RoomController and be event-driven\n            submitRoomForm();\n          } else if (showTos) {\n            PrecallView.showContract().then(() => {\n              Utils.sendEvent('precallView:submit');\n            });\n          } else {\n            Utils.sendEvent('precallView:submit');\n          }\n        }\n\n        otHelper.initPublisher('video-preview', publisherOptions)\n          .then(pub => {\n            publisher = pub;\n\n            otHelper.getVideoDeviceNotInUse(publisherOptions.videoSource)\n              .then(videoSourceId => {\n                previewOptions = {\n                  apiKey: window.precallApiKey,\n                  resolution: '640x480',\n                  sessionId: window.precallSessionId,\n                  token: window.precallToken,\n                  videoSource: videoSourceId\n                };\n\n                publisher.on('accessAllowed', () => {\n                  otHelper.getDevices('audioInput').then(audioDevs => {\n                    // eslint-disable-next-line max-len\n                    PrecallView.populateAudioDevicesDropdown(audioDevs, publisherOptions.audioSource);\n                  });\n                  // You cannot use the network test in IE or Safari because you cannot use two\n                  // eslint-disable-next-line max-len\n                  // publishers (the preview publisher and the network test publisher) simultaneously.\n                  if (!Utils.isIE() && !Utils.isSafariIOS() && window.enablePrecallTest) {\n                    PrecallView.startPrecallTestMeter();\n                    otNetworkTest = new OTNetworkTest(previewOptions);\n                    otNetworkTest.startNetworkTest((error, result) => {\n                      PrecallView.displayNetworkTestResults(result);\n                      if (result.audioOnly) {\n                        publisher.publishVideo(false);\n                        Utils.sendEvent('PrecallController:audioOnly');\n                      }\n                    });\n                  }\n                });\n              });\n            Utils.addEventsHandlers('roomView:', videoPreviewEventHandlers, exports);\n            let movingAvg = null;\n            publisher.on('audioLevelUpdated', event => {\n              if (movingAvg === null || movingAvg <= event.audioLevel) {\n                movingAvg = event.audioLevel;\n              } else {\n                movingAvg = (0.8 * movingAvg) + (0.2 * event.audioLevel);\n              }\n\n              // 1.5 scaling to map the -30 - 0 dBm range to [0,1]\n              let logLevel = ((Math.log(movingAvg) / Math.LN10) / 1.5) + 1;\n              logLevel = Math.min(Math.max(logLevel, 0), 1);\n              PrecallView.setVolumeMeterLevel(logLevel);\n            });\n          });\n        const userNameInputElement = document.getElementById('user-name-input');\n        const storedUsername = window.localStorage.getItem('username');\n        if (username) {\n          document.getElementById('enter-name-prompt').style.display = 'none';\n          userNameInputElement.value = username;\n          userNameInputElement.setAttribute('readonly', true);\n        } else if (storedUsername) {\n          userNameInputElement.value = storedUsername;\n          document.querySelector('#enter-name-prompt label').classList.add('visited');\n        }\n      }\n      otHelper.otLoaded.then(loadModalText);\n    });\n  }\n\n  const eventHandlers = {\n    'roomView:endprecall': endPrecall\n  };\n\n  const init = () => {\n    return new Promise(resolve => {\n      LazyLoader.dependencyLoad([\n        '/js/helpers/ejsTemplate.js',\n        '/js/vendor/ejs_production.js',\n        '/js/min/precallView.min.js'\n      ]).then(() => {\n        Utils.addEventsHandlers('', eventHandlers);\n        return PrecallView.init();\n      }).then(() => {\n        resolve();\n      });\n    });\n  };\n\n  exports.PrecallController = {\n    init,\n    showCallSettingsPrompt\n  };\n})(this);\n"]}