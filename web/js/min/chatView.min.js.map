{"version":3,"sources":["web/js/chatView.js"],"names":["exports","usrId","closeChatBtn","headerChat","sendMsgBtn","chatMsgInput","chatContainer","chatContent","chatForm","chatParticipants","eventHandlers","_visibilityChanging","Promise","resolve","setVisibility","isVisible","addEventListener","onKeyPress","onSubmit","onDrop","onClose","onToggle","onSendClicked","Chat","show","then","Utils","sendEvent","scrollTo","focus","removeEventListener","hide","addEventsHandlers","configuredEvts","incomingMessage","name","[object Object]","evt","data","detail","item","HTMLElems","createElementAt","info","otHelper","isMyself","connectionId","senderId","classList","add","chatIndex","indexOf","push","participantNumber","toString","slice","time","toLowerCase","sender","userName","insertText","text","insertChatLine","visible","presenceEvent","getCurrentTime","insertChatEvent","messageDelivered","value","chatVisibility","couldBeChanged","Array","isArray","forEach","aEvt","event","type","addHandlers","preventDefault","trim","length","window","orientation","document","activeElement","blur","myfield","keycode","vent","keyCode","which","shiftKey","bind","undefined","stopImmediatePropagation","isCollapsed","expand","collapse","stopPropagation","elemRoot","txtElems","TextProcessor","parse","targetElem","node","TYPE","URL","href","target","addText","scrollTop","scrollHeight","ChatView","init","aUsrId","LazyLoader","dependencyLoad","chatWndElem","getElementById","querySelector","initHTMLElements","this"],"mappings":"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","sourcesContent":["/* global Chat, TextProcessor, otHelper */\n\n!(exports => {\n  let usrId;\n\n  let closeChatBtn;\n  let headerChat;\n  let sendMsgBtn;\n  let chatMsgInput;\n  let chatContainer;\n  let chatContent;\n  let chatForm;\n  const chatParticipants = [];\n\n  let _visibilityChanging = Promise.resolve();\n\n  function isMobile() { return typeof window.orientation !== 'undefined'; }\n\n  function isVisible() {\n    return _visibilityChanging.then(() => {\n      return Chat.visible;\n    });\n  }\n\n  function setVisibility(isVisible) {\n    if (isVisible) {\n      addHandlers();\n      return Chat.show().then(() => {\n        Utils.sendEvent('chatView:shown');\n        scrollTo();\n        chatMsgInput.focus();\n      });\n    }\n    removeHandlers();\n    return Chat.hide().then(() => {\n      Utils.sendEvent('chatView:hidden');\n    });\n  }\n\n  let eventHandlers;\n\n  function addEventsHandlers(configuredEvts) {\n    eventHandlers = {\n      incomingMessage: {\n        name: 'chatController:incomingMessage',\n        handler(evt) {\n          const data = evt.detail.data;\n          insertChatLine(data);\n          isVisible().then(visible => {\n            if (!visible) {\n              Utils.sendEvent('chatView:unreadMessage', { data });\n            }\n          });\n        }\n      },\n      presenceEvent: {\n        name: 'chatController:presenceEvent',\n        handler(evt) {\n          insertChatEvent(evt.detail);\n        }\n      },\n      messageDelivered: {\n        name: 'chatController:messageDelivered',\n        handler() {\n          chatMsgInput.value = '';\n        }\n      },\n      chatVisibility: {\n        name: 'roomView:chatVisibility',\n        handler(evt) {\n          _visibilityChanging = setVisibility(evt.detail);\n        },\n        couldBeChanged: true\n      }\n    };\n    Array.isArray(configuredEvts) && configuredEvts.forEach(aEvt => {\n      const event = eventHandlers[aEvt.type];\n      event && event.couldBeChanged && (event.name = aEvt.name);\n    });\n    Utils.addHandlers(eventHandlers);\n  }\n\n  function initHTMLElements() {\n    const chatWndElem = document.getElementById('chat');\n    headerChat = chatWndElem.querySelector('header');\n    closeChatBtn = chatWndElem.querySelector('#closeChat');\n    sendMsgBtn = chatWndElem.querySelector('#sendTxt');\n    chatMsgInput = chatWndElem.querySelector('#msgText');\n    chatContainer = chatWndElem.querySelector('#chatMsgs');\n    chatContent = chatContainer.querySelector('ul');\n    chatForm = chatWndElem.querySelector('#chatForm');\n  }\n\n  const onSendClicked = evt => {\n    evt.preventDefault();\n    if (!chatMsgInput.value.trim().length) {\n      return;\n    }\n    if (isMobile()) {\n      document.activeElement.blur(); // Hide the virtual keyboard.\n    } else {\n      chatMsgInput.focus();\n    }\n    Utils.sendEvent('chatView:outgoingMessage', {\n      sender: usrId,\n      time: Utils.getCurrentTime(),\n      text: chatMsgInput.value.trim()\n    });\n  };\n\n  const onKeyPress = ((myfield, evt) => {\n    let keycode;\n    if (window.vent) {\n      keycode = window.event.keyCode;\n    } else if (evt) {\n      keycode = evt.which;\n    } else {\n      return true;\n    }\n    if (keycode === 13) {\n      if (evt.shiftKey === true) {\n        return true;\n      }\n      onSendClicked(evt);\n      return false;\n    }\n    return true;\n  }).bind(undefined, chatMsgInput);\n\n  const onSubmit = evt => {\n    evt.preventDefault();\n    return false;\n  };\n\n  const onClose = evt => {\n    evt.preventDefault();\n    evt.stopImmediatePropagation();\n    _visibilityChanging = setVisibility(false);\n  };\n\n  const onToggle = () => {\n    Chat.isCollapsed() ? Chat.expand() : Chat.collapse();\n  };\n\n  const onDrop = evt => {\n    evt.preventDefault();\n    evt.stopPropagation();\n    return false;\n  };\n\n  // The ChatController should have the handlers and call the view for\n  // doing visual work\n  function addHandlers() {\n    chatForm.addEventListener('keypress', onKeyPress);\n    chatForm.addEventListener('submit', onSubmit);\n    chatForm.addEventListener('drop', onDrop);\n    closeChatBtn.addEventListener('click', onClose);\n    headerChat.addEventListener('click', onToggle);\n    sendMsgBtn.addEventListener('click', onSendClicked);\n  }\n\n  function removeHandlers() {\n    chatForm.removeEventListener('keypress', onKeyPress);\n    closeChatBtn.removeEventListener('click', onClose);\n    headerChat.removeEventListener('click', onToggle);\n    sendMsgBtn.removeEventListener('click', onSendClicked);\n    chatForm.removeEventListener('drop', onDrop);\n  }\n\n  function insertChatEvent(data) {\n    const time = (data.time || Utils.getCurrentTime()).toLowerCase();\n    const item = HTMLElems.createElementAt(chatContent, 'li');\n    item.classList.add('event');\n    const name = data.sender || data.userName;\n    const text = `${time} - ${name} ${data.text}`;\n    insertText(item, text);\n    scrollTo();\n  }\n\n  function insertText(elemRoot, text) {\n    const txtElems = TextProcessor.parse(text);\n    const targetElem = HTMLElems.createElementAt(elemRoot, 'p');\n    txtElems.forEach(node => {\n      switch (node.type) {\n        case TextProcessor.TYPE.URL:\n          HTMLElems.createElementAt(targetElem, 'a',\n            { href: node.value, target: '_blank' }, node.value);\n          break;\n        default:\n          HTMLElems.addText(targetElem, node.value);\n      }\n    });\n  }\n\n  function insertChatLine(data) {\n    const item = HTMLElems.createElementAt(chatContent, 'li');\n    const info = HTMLElems.createElementAt(item, 'p');\n    if (otHelper.isMyself({ connectionId: data.senderId })) {\n      item.classList.add('yourself');\n    } else {\n      let chatIndex = chatParticipants.indexOf(data.senderId);\n      if (chatIndex === -1) {\n        chatIndex = chatParticipants.push(data.senderId) - 1;\n      }\n      // We only have 10 colors so just get last digit.\n      const participantNumber = chatIndex.toString().slice(-1);\n      info.data('participant-number', participantNumber);\n    }\n\n    const time = data.time.toLowerCase();\n    HTMLElems.createElementAt(info, 'span', null, time).classList.add('time');\n    HTMLElems.createElementAt(info, 'span', null, data.sender || data.userName)\n      .classList.add('sender');\n\n    insertText(info, data.text);\n\n    scrollTo();\n  }\n\n  function scrollTo() {\n    chatContainer.scrollTop = chatContainer.scrollHeight;\n  }\n\n  function init(aUsrId, configuredEvts) {\n    return LazyLoader.dependencyLoad([\n      '/js/helpers/textProcessor.js',\n      '/js/components/chat.js'\n    ]).then(() => {\n      initHTMLElements();\n      usrId = aUsrId;\n      Chat.init();\n      addEventsHandlers(configuredEvts);\n    });\n  }\n\n  const ChatView = {\n    init\n  };\n\n  exports.ChatView = ChatView;\n})(this);\n"]}