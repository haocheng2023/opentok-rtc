(e=>{const o=new Utils.MultiLevelLogger("roomController.js",Utils.MultiLevelLogger.DEFAULT_LEVELS.all);let t,n,i=0,s=!1,r=!0,a=!1,l=!1,d=!1,u=!1,c=null;const m=new Promise(e=>{n=e});let h={roomMuted:!1},b=window.userName,p=null,g=null,v=null,w=null;const f={insertMode:"append",width:"100%",height:"100%",showControls:!0,resolution:publisherResolution,style:{audioLevelDisplayMode:"auto",buttonDisplayMode:"off",nameDisplayMode:"off",videoDisabledDisplayMode:"on",showArchiveStatus:!1}},y={camera:{height:"100%",width:"100%",inserMode:"append",showControls:!0,style:{audioLevelDisplayMode:"auto",buttonDisplayMode:"off",nameDisplayMode:"off",videoDisabledDisplayMode:"auto",showArchiveStatus:!1}},screen:{height:"100%",width:"100%",inserMode:"append",showControls:!1,style:{audioLevelDisplayMode:"off",buttonDisplayMode:"off",nameDisplayMode:"on",videoDisabledDisplayMode:"off"}},noVideo:{height:"100%",width:"100%",inserMode:"append",showControls:!0,style:{audioLevelDisplayMode:"auto",buttonDisplayMode:"off",nameDisplayMode:"on",videoDisabledDisplayMode:"off"}}},C=(e,o)=>{const t="screen"===e,n={};return o||(n.video={eventFiredName:"roomView:buttonClick",dataIcon:t?"desktop":"video",eventName:"click",context:"otHelper",action:"toggleSubscribersVideo",enabled:!0}),t||(n.audio={eventFiredName:"roomView:buttonClick",dataIcon:"audio",eventName:"click",context:"otHelper",action:"toggleSubscribersAudio",enabled:!0}),o&&o in S&&(n.hangup={eventFiredName:"roomView:buttonClick",dataIcon:"hangup",eventName:"click",context:"otHelper",action:"hangup",enabled:!0}),n},E={video:{eventFiredName:"roomView:buttonClick",dataIcon:"video",eventName:"click",context:"otHelper",action:"togglePublisherVideo",enabled:!0},audio:{eventFiredName:"roomView:buttonClick",dataIcon:"mic",eventName:"click",context:"otHelper",action:"togglePublisherAudio",enabled:!0}};let R={};var S={};const V=e=>{const o=e.target;if("style"!==e.attributeName&&"class"!==e.attributeName||"camera"!==o.data("streamType"))return;const n=o.data("id");(R[n]&&R[n].subscriberPromise).then(e=>{v&&(window.subscriberElem=window.subscriberElem||{},window.subscriberElem[n]=o,window.subscriber=window.subscriber||{},window.subscriber[n]=e,window.dumpResolutionInfo=window.dumpResolutionInfo||(()=>{Object.keys(window.subscriber).forEach(e=>{const o=window.subscriber[e],t=o&&o.stream,n=t&&t.videoDimensions,i=t&&t.getPreferredResolution()||{width:"NA",height:"NA"};t&&console.log("StreamId:",e,"Real:",o.videoWidth(),"x",o.videoHeight(),"Stream.getPreferredResolution:",i.width,"x",i.height,"Stream.VDimension:",n.width,"x",n.height)})}));const s=o.parentNode,r={width:s.clientWidth,height:s.clientHeight},a={width:o.clientWidth,height:o.clientHeight};t.setPreferredResolution(e,r,a,i-1,g)})},I=(e.MutationObserver&&new e.MutationObserver(e=>{e.forEach(V)}),e=>{e&&Utils.sendEvent("roomController:"+(e.hasVideo?"videoEnabled":"videoDisabled"),{id:e.streamId})}),j=e=>{const o={userName:b,roomName:p,operation:e};Request.sendArchivingOperation(o)},M=e=>{if(Object.keys(R).some(o=>{if(R[o]){const t=R[o].stream;return t.isSip&&t.name===e}return!1}))console.log("The number is already in this call: "+e);else{let o;if(u){o=c.currentUser.get().getAuthResponse().id_token}else o="";const t={phoneNumber:e,googleIdToken:o};Request.dialOut(p,t),S[e]=o}},k={updatedRemotely(){m.then(()=>{h=RoomStatus.get("room");const e=h.roomMuted;N(e),e&&Utils.sendEvent("roomController:roomMuted",{isJoining:!0})})}};var U=(e,o,t)=>{P.buttonClick({detail:{streamId:e,name:o,disableAll:!0,status:t}})};function A(e,o){t.sendSignal("muteAll",{status:e,onlyChangeSwitch:o})}var P={endCall(){t.disconnect();const e=window.location.origin.concat("/thanks");window.location.href=e},startArchiving(e){j(e.detail&&e.detail.operation||"startComposite")},stopArchiving(){j("stop")},streamVisibilityChange(e){const o=e.detail.id;if("publisher"!==o){const n=R[o];n&&t.toggleSubscribersVideo(n.stream,(o=>{let t=null;return"hidden"===e.detail.value?(o.prevEnabled="prevEnabled"in o?o.prevEnabled:o.enabled,t=!1):(t="prevEnabled"in o?o.prevEnabled:o.enabled,delete o.prevEnabled),t})(n.buttons.video))}},buttonClick(n){const i=n.detail.streamId,s=n.detail.streamType,r=n.detail.name,a=!!n.detail.disableAll,l=n.detail.status;let d=null;const u=[];let c;const m="publisher"===i;if(m){if(d=E[r],c=!d.enabled,!t.isPublisherReady||t.publisherHas(r)===c)return}else{const e=R[i];if(!e)return void o.error("Got an event from an nonexistent stream");if("hangup"===r)return void(e=>{if(!R[e])return;const o=R[e].stream;if(!o.isSip)return;const t=o.phoneNumber;if(!(t in S))return;const n=S[t];Request.hangUp(t,n),delete S[t]})(i);d=e.buttons[r],u.push(e.stream),c=!d.enabled,"screen"!==s&&"audio"!==r||D({stream:e.stream},r,c)}if(d){if(u.push(c),!a||a&&l!==c){if(e[d.context][d.action](...u),!a&&"screen"!==s){const e="audio"===r&&m,o="video"===r&&!m;(e||o)&&(Utils.sendEvent("roomController:userChangeStatus",{status:c,name:r}),e&&(A(!1,!0),h.roomMuted=!1))}}}else o.error("Got an event from an unknown button!")},videoSwitch(e){var o,t;o="video",t=e.detail.status,s=t,Object.keys(R).forEach(e=>{R[e]&&"camera"===R[e].stream.videoType&&U(e,o,t)})},muteAllSwitch(e){const o=e.detail.status;h.roomMuted=o,N(o),A(o,!1)},dialOut(e){if(e.detail){const o=e.detail.replace(/\D/g,"");u&&!0!==c.isSignedIn.get()?c.signIn().then(()=>{document.body.data("google-signed-in","true"),M(o)}):M(o)}},addToCall(){void 0!==window.orientation&&navigator.share?navigator.share({title:"Invite Participant",url:location.href}).then(()=>{console.log("Successful share")}).catch(e=>{console.log("Error sharing",e)}):function(){const e=".add-to-call-modal";Modal.show(e).then(()=>new Promise(o=>{const t=document.querySelector(e+" button");t&&t.addEventListener("click",(function n(i){i.preventDefault(),t.removeEventListener("click",n),"copyInviteLinkBtn"===t.id?function(e){const o=document.getElementById("copyInviteLinkBtn"),t=document.getElementById("current-url");t&&t.textContent&&navigator.clipboard.writeText(t.textContent.trim()).then(()=>{if("Copied!"!==o.innerText){const t=o.innerText;o.innerText="Copied!",setTimeout(()=>{Modal.hide(e),o.innerText=t},2e3)}})}(e):Modal.hide(e),o()}))}))}()},togglePublisherAudio(e){const o=e.detail.hasAudio;t.isPublisherReady&&t.publisherHas("audio")===o||t.togglePublisherAudio(o)},togglePublisherVideo(e){const o=e.detail.hasVideo;t.isPublisherReady&&t.publisherHas("video")===o||t.togglePublisherVideo(o)},setRoomLockState(e){const o=e.detail,n={userName:b,token:w,state:o,roomURI:p};Request.sendLockingOperation(n).then(()=>{return e=o,void t.sendSignal("roomLocked",{status:e});var e})}},N=e=>{t.isPublisherReady&&P.buttonClick({detail:{streamId:"publisher",name:"audio",disableAll:!0,status:e}})},D=(e,o,t)=>{let n=e.stream||e.target.stream;if(!n)return;const i=n.streamId;n=R[i];const s=n?n.buttons[o]:E[o];s.enabled=!!t,Utils.sendEvent("roomController:"+o,{id:i,reason:e.reason,enabled:s.enabled})};const L={videoDisabled(e){"subscribeToVideo"===e.reason&&D(e,"video"),I(e.target.stream)},videoEnabled(e){"subscribeToVideo"===e.reason&&D(e,"video",!0),I(e.target.stream)},disconnected(e){Utils.sendEvent("roomController:disconnected",{id:e.target.stream.streamId})},connected(e){Utils.sendEvent("roomController:connected",{id:e.target.stream.streamId})}};let O={connectionCreated(){RoomView.participantsNumber=++i},connectionDestroyed(){RoomView.participantsNumber=--i},sessionConnected(){Utils.sendEvent("roomController:sessionConnected")},sessionDisconnected(){i=0,Utils.sendEvent("roomController:sessionDisconnected"),R={}},streamCreated(e){m.then(()=>{const n=e.stream,i=n.videoType||"noVideo";let a;try{a=JSON.parse(n.connection.data)}catch(m){a={}}n.isSip=!!a.sip,n.name||(n.name=a.name||"");const l=n.streamId;n.phoneNumber=n.isSip&&n.name,n.isSip&&(n.name="Invited Participant"),R[l]={stream:n,buttons:C(i,n.phoneNumber)};const d=y[i],u="camera"===i&&s;h=RoomStatus.get("room");const c=RoomView.createStreamView(l,{name:n.name,type:n.videoType,controlElems:R[l].buttons});d.subscribeToVideo=!u,R[l].subscriberPromise=t.subscribe(e.stream,c,d,{},r).then(o=>{if("screen"===i){r&&Utils.sendEvent("roomController:annotationStarted");const e=o.element.parentElement;return Utils.sendEvent("layoutView:itemSelected",{item:e}),o}return Object.keys(L).forEach(e=>{o.on(e,L[e])}),u&&U(l,"video",!0),new ResizeSensor(c,()=>{const e={width:c.clientWidth,height:c.clientHeight};t.setPreferredResolution(o,null,e,null,null)}),I(e.stream),o},e=>{o.error("Error susbscribing new participant. "+e.message)})})},streamDestroyed(e){const o=e.stream;"screen"===o.videoType&&Utils.sendEvent("roomController:annotationEnded"),RoomView.deleteStreamView(o.streamId),R[o.streamId]=null},streamPropertyChanged(e){t.publisherId===e.stream.id&&("hasVideo"===e.changedProperty?(e.reason="publishVideo",D(e,"video",e.newValue)):"hasAudio"===e.changedProperty&&(e.reason="publishAudio",D(e,"audio",e.newValue)))},archiveStarted(e){Utils.sendEvent("archiving",{status:"started",id:e.id})},archiveStopped(){Utils.sendEvent("archiving",{status:"stopped"})},"signal:roomLocked":function(e){const o=JSON.parse(e.data).status;Utils.sendEvent("roomController:roomLocked",o)},"signal:muteAll":function(e){const o=JSON.parse(e.data),n=o.status;if(o.onlyChangeSwitch)return;const i=(e=>{h.roomMuted===e&&N(e)}).bind(void 0,n);t.isMyself(e.from)||(h.roomMuted=n,n?(N(n),Utils.sendEvent("roomController:roomMuted",{isJoining:!1})):RoomView.showConfirmChangeMicStatus(n).then(i))},"signal:archives":function(e){Utils.sendEvent("roomController:archiveUpdates",e)}};function T(){if(!e.RoomController)throw new Error("Room Controller is not defined. Missing script tag?");const o=document.location.pathname.split("/");if(!o||o.length<2)throw new Error("Invalid path");let n="",i="";const s=o.length;s>0&&(i=o[s-1]),n=Utils.decodeStr(i);const r=Utils.parseSearch(document.location.search),l=window.userName||r.getFirstValue("userName");return g=r.getFirstValue("resolutionAlgorithm"),v=r.getFirstValue("debugPreferredResolution"),a=void 0!==r.getFirstValue("enableHangoutScroll"),PrecallController.showCallSettingsPrompt(n,l,t).then(e=>(e.roomURI=i,RoomView.showRoom(),RoomView.roomURI=i,f.publishAudio=e.publisherOptions.publishAudio,f.publishVideo=e.publisherOptions.publishVideo,f.audioSource=e.publisherOptions.audioSource,f.videoSource=e.publisherOptions.videoSource,e))}function H(e){return Request.getRoomInfo(e).then(t=>{if(!(t&&t.token&&t.sessionId&&t.apiKey&&t.username)||t.enableArchiveManager&&(!t.firebaseToken||!t.firebaseURL))throw o.error("Error getRoomParams [",t,"] without correct response"),new Error("Error getting room parameters");return t.roomURI=e.roomURI,t.publishAudio=e.publishAudio,t.publishVideo=e.publishVideo,r=t.enableAnnotation,l=t.enableArchiveManager,d=t.enableSip,u=t.requireGoogleAuth,t})}const x=["/js/components/htmlElems.js","/js/helpers/resolutionAlgorithms.js","/js/helpers/opentok-network-test.js","/js/itemsHandler.js","/js/layoutView.js","/js/layouts.js","/js/layoutManager.js","/js/roomView.js","/js/roomStatus.js","/js/min/chatController.min.js","/js/min/recordingsController.min.js","/js/min/precallController.min.js","/js/layoutMenuController.js","/js/min/screenShareController.min.js","/js/min/feedbackController.min.js","/js/googleAuth.js","/js/min/phoneNumberController.min.js","/js/vendor/ResizeSensor.js"],F={init:()=>{LazyLoader.load(x).then(()=>(Utils.addEventsHandlers("roomView:",P,e),Utils.addEventsHandlers("roomStatus:",k,e),Utils.addEventsHandlers("precallView:",{submit(){}}),PrecallController.init())).then(()=>LazyLoader.load("/js/helpers/OTHelper.js")).then(()=>{t=new OTHelper({}),e.otHelper=t}).then(T).then(H).then(o=>{let t=Promise.resolve();return r&&(e.OTKAnalytics=e.OTKAnalytics||(()=>({addSessionInfo(){},logEvent(e,o){console.log(e,o)}})),t=LazyLoader.load(["https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js","/js/vendor/opentok-annotation.js"])),t.then(()=>o)}).then(e=>{RoomView.init(a,l,d),RecordingsController.init(l),p=e.roomURI,b=e.username?e.username.substring(0,1e3):"",b=Utils.htmlEscape(b.substring(0,25)),w=e.token;const s={apiKey:e.apiKey,sessionId:e.sessionId,token:e.token},m=t.connect.bind(t,s);RoomView.participantsNumber=0,O=RoomStatus.init(O,{room:h}),d&&u&&GoogleAuth.init(e.googleId,e.googleHostedDomain,e=>{c=e,c.isSignedIn.get()&&document.body.data("google-signed-in","true")}),ChatController.init(b,O).then(m).then(LayoutMenuController.init).then(()=>new Promise(e=>maxUsersPerRoom?setTimeout(()=>{i>maxUsersPerRoom?Utils.sendEvent("roomController:meetingFullError"):e()},500):e())).then(()=>{const e=RoomView.createStreamView("publisher",{name:b,type:"publisher"});return h.roomMuted&&(D({stream:{streamId:"Publisher"},reason:"publishAudio"},"audio",!1),f.publishAudio=!1),f.name=b,Utils.isIE()&&(f.usePreviousDeviceSelection=!0),t.publish(e,f,{}).then(()=>{n(),RoomView.showPublisherButtons(f)}).catch(e=>{"OT_CHROME_MICROPHONE_ACQUISITION_ERROR"===e.error.name&&(Utils.sendEvent("roomController:chromePublisherError"),t.disconnect())})}).then(()=>{ScreenShareController.init(b,e.chromeExtId,t,r),FeedbackController.init(t,e.reportIssueLevel),PhoneNumberController.init(),Utils.sendEvent("roomController:controllersReady")}).catch(e=>{o.error("Error Connecting to room. "+e.message)})})}};e.RoomController=F})(this);